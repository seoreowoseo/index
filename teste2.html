<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Overlay - Cartoon Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://socialstream.ninja/libs/colours.js" type="text/javascript"></script>
<style>
body, html {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    font-family: 'Baloo 2', cursive;
    background-color: transparent;
    overflow: hidden;
    box-sizing: border-box;
}

#chat-container {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 400px;
    height: 100vh;
    overflow: hidden;
    padding: 0 25px;
    box-sizing: border-box;
}

.message {
    background: #b7e8a0; /* verde claro */
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 25px;
    border: 3px solid #7cc36d;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    color: #3a2d1f; /* marrom escuro */
    font-size: 1em;
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    position: relative;
}

.message.visible {
    opacity: 1;
    transform: translateY(0);
}

.name-bg {
    background-color: #ffda77; /* amarelo fofinho */
    color: #3a2d1f;
    padding: 5px 10px;
    border-radius: 10px;
    font-weight: bold;
    display: inline-block;
    margin-bottom: 5px;
    box-shadow: 2px 2px 0 #e3b944;
}

.text {
    font-size: 1.1em;
    line-height: 1.5;
    margin-top: 5px;
}

.text img {
    max-height: 40px; /* emojis grandes */
    vertical-align: middle;
}

.avatar-wrapper {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    margin-right: 12px;
    overflow: hidden;
    border: 3px solid #7cc36d;
    background: white;
}

.avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
}

.message-content-wrapper {
    display: flex;
    align-items: flex-start;
}
</style>
</head>
<body>
<div id="chat-container">
    <div id="message-list-wrapper">
        <div id="spacer" style="height: 2200px; width: 100%;"></div>
    </div>
</div>
<script>
    var urlParams = new URLSearchParams(window.location.search);
    var roomID = "iWWnKL28tQ";
    if (urlParams.has("session")) {
        roomID = urlParams.get("session");
    }
    var password = "false";
    var featuredMode = false;

    const chatContainer = document.getElementById('chat-container');
    const messageListWrapper = document.getElementById('message-list-wrapper');
    const MAX_MESSAGES = urlParams.has("limit") ? parseInt(urlParams.get("limit")) : 20;
    const topSpacer = document.getElementById('spacer');
    const messageTimestamps = new Map();
    const MAX_SPACER_HEIGHT_BEFORE_RESET = 18000000; 

    function adjustMessageWrapperScroll() {
        requestAnimationFrame(() => {
            const wrapperScrollHeight = messageListWrapper.scrollHeight;
            const containerClientHeight = chatContainer.clientHeight;
            let translateY = 0;
            if (wrapperScrollHeight > containerClientHeight) {
                translateY = -(wrapperScrollHeight - containerClientHeight);
            }
            translateY = Math.min(0, translateY);
            messageListWrapper.style.transform = `translateY(${translateY}px)`;
        });
    }

    setInterval(() => {
        const now = Date.now();
        const messages = Array.from(messageListWrapper.children).filter(
            child => child.id !== 'spacer' && child.classList.contains('message')
        );
        messages.forEach(message => {
            const timestamp = messageTimestamps.get(message.id);
            if (timestamp) {
                const age = now - timestamp;
                if (age > 30000 && !message.classList.contains('fading')) {
                    message.classList.add('fading');
                }
            }
        });
    }, 1000); 

    function addMessageToOverlay(data) {
        if (!data.chatname && !data.chatmessage && !data.hasDonation && !data.donation && !data.contentimg){
            return;
        }

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');

        const messageId = data.mid || 'msg-' + Date.now();
        messageDiv.id = messageId;
        messageTimestamps.set(messageId, Date.now());

        const avatarHtml = data.chatimg ? 
            `<div class="avatar-wrapper"><div class="avatar" style="background-image: url('${data.chatimg}');"></div></div>` : '';
        const nameHtml = data.chatname ? `<div class="name-bg">${data.chatname}</div>` : '';
        const messageTextHtml = `<div class="text">${data.chatmessage ? data.chatmessage : ''}</div>`;

        messageDiv.innerHTML = `
            <div class="message-content-wrapper">
                ${avatarHtml}
                <div class="message-text-meta">
                    ${nameHtml}
                    ${messageTextHtml}
                </div>
            </div>
        `;

        messageListWrapper.appendChild(messageDiv);
        void messageDiv.offsetWidth;
        messageDiv.classList.add('visible');

        const messages = Array.from(messageListWrapper.children).filter(
            child => child.id !== 'spacer' && child.classList.contains('message') 
        );

        if (messages.length > MAX_MESSAGES) {
            const oldestMessage = messages[0]; 
            if (oldestMessage) {
                const spaceOccupied = oldestMessage.offsetHeight + (parseFloat(getComputedStyle(oldestMessage).marginBottom) || 0);
                const currentSpacerHeight = parseFloat(topSpacer.style.height) || 0;
                let newHeight = currentSpacerHeight + spaceOccupied;
                if (newHeight > MAX_SPACER_HEIGHT_BEFORE_RESET) newHeight = 0;
                topSpacer.style.height = newHeight + 'px';
                messageTimestamps.delete(oldestMessage.id);
                messageListWrapper.removeChild(oldestMessage);
            }
        }
        adjustMessageWrapperScroll();
    }

    var iframe = document.createElement("iframe");
    if (featuredMode){
        iframe.src = `https://vdo.socialstream.ninja/?ln&password=${password}&salt=vdo.ninja&label=overlay&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`;
    } else {
        iframe.src = "https://vdo.socialstream.ninja/?ln&salt=vdo.ninja&password="+password+"&push&label=dock&vd=0&ad=0&novideo&noaudio&autostart&cleanoutput&room="+roomID; 
    }
    iframe.style.cssText = "width:0;height:0;position:fixed;left:-100px;top:-100px;";
    document.body.appendChild(iframe);

    window.addEventListener("message", function (e) {
        if (e.source != iframe.contentWindow) return;
        if (e.data.dataReceived && e.data.dataReceived.overlayNinja) {
            addMessageToOverlay(e.data.dataReceived.overlayNinja);
        }
    });
</script>
</body>
</html>

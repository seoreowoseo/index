<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Animal Crossing Overlay - Debug</title>
<meta name="generator" content="Social Stream Ninja - https://github.com/steveseguin/social_stream">
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
<style>
body, html {
  background: transparent;
  font-family: 'Baloo 2', cursive;
  margin:0; padding:0;
}
#chat-container {
  position: fixed;
  bottom: 0; left: 0;
  display: flex; flex-direction: column;
  gap: 20px;
  max-width: 500px; width: 100%;
  padding: 20px;
}
.chat-message {
  display: flex; align-items: flex-end;
  animation: fadeIn 0.5s ease-in-out forwards;
}
.avatar-icon-group {
  position: relative; width: 70px; height: 70px;
  margin-right: 15px; flex-shrink: 0;
}
.chat-avatar {
  width: 70px; height: 70px; border-radius: 50%;
  border: 3px solid white; overflow: hidden;
  background-color: #f0f0f0;
}
.chat-avatar img {
  width: 100%; height: 100%; object-fit: cover;
}
.secondary-icon {
  position: absolute; bottom: -5px; right: -15px;
  width: 35px; height: 35px; z-index: 3;
}
.secondary-icon img {
  width: 100%; height: 100%; object-fit: contain;
}
.message-group {
  position: relative; flex-grow: 1;
  display: flex; flex-direction: column; align-items: flex-start;
}
.message-bubble {
  padding: 15px 20px; border-radius: 25px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.2);
  background-color: white; max-width: 90%;
  font-weight: 800; color: #4b4b4b; font-size: 16px;
}
.chat-message.moderator .message-bubble { background-color: #b4cce4; }
.chat-message.member .message-bubble    { background-color: #e4b887; }
.chat-message.founder .message-bubble   { background-color: #F78C4A; }
.chat-message.viewer .message-bubble    { background-color: white; }
.chat-message.superchat .message-bubble { background-color: #ffc30f; color: #000; padding-right: 36px; }
.chat-message.cheer .message-bubble     { background-color: #D1C4E9; color: #4A148C; padding-right: 36px; }
.username-container {
  position: absolute; top: -15px; left: 5px;
  border-radius: 10px; padding: 4px 10px;
  transform: rotate(-5deg); z-index: 10;
}
.chat-message.moderator .username-container { background-color: #3fd8e0; }
.chat-message.member .username-container    { background-color: #e4b887; }
.chat-message.founder .username-container   { background-color: #ef1f26; }
.chat-message.viewer .username-container    { background-color: #b19385; }
.username { font-weight: bold; color: #fff; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
.chat-message.superchat .superchat-icon,
.chat-message.cheer .cheer-icon {
  position: absolute; top: 20%; right: -2px;
  transform: translateY(-50%); width: 30px; height: 30px;
}
@keyframes fadeIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
</style>
</head>
<body>
<div id="chat-container"></div>

<script>
console.log("[DEBUG] Overlay carregado.");

// === PARAMS ===
const urlParams = new URLSearchParams(window.location.search);
const roomID   = urlParams.get("session") || "defaultRoom";
const password = urlParams.get("password") || "false";
const limit    = parseInt(urlParams.get("limit") || "20", 10);
const useWS    = urlParams.has("server") || urlParams.has("server2");
let   serverURL= urlParams.get("server") || urlParams.get("server2") || "wss://io.socialstream.ninja";
const localTest= urlParams.has("localtest");

console.log("[DEBUG] Session ID:", roomID);
console.log("[DEBUG] Params -> limit:", limit, "| useWS:", useWS, "| serverURL:", serverURL, "| localTest:", localTest);

// === IFRAME (WebRTC data channel) ===
const iframe = document.createElement("iframe");
iframe.src = "https://vdo.socialstream.ninja/?ln&salt=vdo.ninja"
          + "&password=" + encodeURIComponent(password)
          + "&push&label=dock&vd=0&ad=0&novideo&noaudio&autostart&cleanoutput"
          + "&room=" + encodeURIComponent(roomID);
iframe.style.cssText = "width:0;height:0;position:fixed;left:-100px;top:-100px;";
document.body.appendChild(iframe);
iframe.onload = () => console.log("[DEBUG] iFrame de conexão carregado.");

// Listener de mensagens do iframe
window.addEventListener("message", function(e){
  if (e.source !== iframe.contentWindow) return;
  // Logue tudo pra ver o que chega
  console.log("[DEBUG] postMessage origin:", e.origin, "| raw:", e.data);
  const payload = e?.data?.dataReceived?.overlayNinja;
  if (payload) {
    console.log("[DEBUG] Mensagem recebida do SSN (iframe):", payload);
    addMessageToOverlay(payload);
  } else {
    console.log("[DEBUG] Evento recebido do iframe, mas sem overlayNinja.");
  }
});

// === WS opcional (fallback) — só ativa se passar &server ou &server2 na URL ===
let socketserver = null;
let reconnectBackoff = 1;

function setupSocket(){
  socketserver.onopen = function(){
    console.log("[DEBUG] WebSocket conectado:", serverURL);
    reconnectBackoff = 1;
    // out/in = compat com sample
    socketserver.send(JSON.stringify({"join":roomID, "out":3, "in":4}));
  };
  socketserver.onclose = function(){
    console.warn("[DEBUG] WebSocket fechado. Tentando reconectar…");
    setTimeout(function(){
      reconnectBackoff+=1;
      socketserver = new WebSocket(serverURL);
      setupSocket();
    }, 100 * reconnectBackoff);
  };
  socketserver.addEventListener('message', function (event) {
    if (!event.data) return;
    try {
      const data = JSON.parse(event.data);
      console.log("[DEBUG] WS message:", data);
      if (data) addMessageToOverlay(data);
    } catch (err) {
      console.error("[ERRO] Falha ao processar WS message:", err, "bruto:", event.data);
    }
  });
}
if (useWS){
  try {
    socketserver = new WebSocket(serverURL);
    setupSocket();
  } catch (err) {
    console.error("[ERRO] WebSocket init:", err);
  }
}

// === Timeout de sanidade: avisa se nada chegou em X segundos
let gotAnyMessage = false;
setTimeout(()=>{
  if (!gotAnyMessage){
    console.warn("[DEBUG] Nenhuma mensagem recebida nos primeiros 10s. Verifique session, SSN e painéis de envio.");
  }
}, 10000);

// === RENDER ===
const chatContainer = document.getElementById('chat-container');

function addMessageToOverlay(data) {
  gotAnyMessage = true;
  console.log("[DEBUG] addMessageToOverlay payload:", data);

  // Não descarte logo de cara; logue e tente renderizar
  if (!data.chatname && !data.chatmessage) {
    console.warn("[DEBUG] Mensagem sem nome/texto — renderizando mesmo assim (modo debug).");
  }

  const isSuper = (data.chatmessage || "").toLowerCase().includes("super chat");
  const isCheer = (data.type || "").toLowerCase().includes("cheer");

  if (isSuper) {
    data.secondaryIconUrl = 'https://dodo.ac/np/images/thumb/3/3c/Heart_Crystal_NH_Inv_Icon.png/96px-Heart_Crystal_NH_Inv_Icon.png';
    console.log("[DEBUG] SUPERCHAT detectado (secondary = coração)");
  }

  const msgEl = document.createElement('div');
  msgEl.classList.add('chat-message', (data.role||'viewer').toLowerCase());
  if (isSuper) msgEl.classList.add('superchat');
  if (isCheer) msgEl.classList.add('cheer');

  // Avatar + secondary
  const avatarGroup = document.createElement('div');
  avatarGroup.classList.add('avatar-icon-group');

  const avatarDiv = document.createElement('div');
  avatarDiv.classList.add('chat-avatar');
  const avatarImg = document.createElement('img');
  avatarImg.src = data.chatimg || '';
  avatarImg.onload = () => console.log(`[DEBUG] Avatar carregado para ${data.chatname||"sem nome"}`);
  avatarImg.onerror = () => console.error(`[ERRO] Falha ao carregar avatar para ${data.chatname||"sem nome"}`);
  avatarDiv.appendChild(avatarImg);
  avatarGroup.appendChild(avatarDiv);

  if (data.secondaryIconUrl) {
    const secDiv = document.createElement('div');
    secDiv.classList.add('secondary-icon');
    const secImg = document.createElement('img');
    secImg.src = data.secondaryIconUrl;
    secImg.onload = () => console.log(`[DEBUG] Secondary icon carregado para ${data.chatname||"sem nome"}`);
    secImg.onerror = () => console.error(`[ERRO] Falha ao carregar secondary icon para ${data.chatname||"sem nome"}`);
    secDiv.appendChild(secImg);
    avatarGroup.appendChild(secDiv);
  }
  msgEl.appendChild(avatarGroup);

  // Nome e balão
  const messageGroup = document.createElement('div');
  messageGroup.classList.add('message-group');

  const usernameContainer = document.createElement('div');
  usernameContainer.classList.add('username-container');
  const usernameSpan = document.createElement('span');
  usernameSpan.classList.add('username');
  usernameSpan.textContent = data.chatname || '';
  usernameContainer.appendChild(usernameSpan);
  messageGroup.appendChild(usernameContainer);

  const bubble = document.createElement('div');
  bubble.classList.add('message-bubble');
  bubble.textContent = data.chatmessage || '';

  // Ícones no balão
  const bellBagUrl = 'https://dodo.ac/np/images/thumb/d/d3/Bell_Bag_NH_Inv_Icon.png/96px-Bell_Bag_NH_Inv_Icon.png';
  if (isCheer) {
    const cheerIcon = document.createElement('img');
    cheerIcon.classList.add('cheer-icon');
    cheerIcon.src = bellBagUrl;
    bubble.appendChild(cheerIcon);
  }
  if (isSuper) {
    const superIcon = document.createElement('img');
    superIcon.classList.add('superchat-icon');
    superIcon.src = bellBagUrl;
    bubble.appendChild(superIcon);
  }

  messageGroup.appendChild(bubble);
  msgEl.appendChild(messageGroup);

  chatContainer.appendChild(msgEl);

  // Limite de mensagens na tela
  if (chatContainer.childElementCount > limit) {
    chatContainer.removeChild(chatContainer.firstChild);
    console.log("[DEBUG] Mensagem removida para manter limite de", limit);
  }
}

// === Local test opcional (para validar render sem SSN): use &localtest=1
if (localTest){
  setTimeout(()=>{
    console.log("[DEBUG] Injectando mensagem local de teste (localtest=1)");
    addMessageToOverlay({
      chatname: "Isabelle",
      chatmessage: "Teste local do overlay 🌴",
      chatimg: "https://i.pravatar.cc/70?img=12",
      type: "twitch",
      role: "member"
    });
  }, 500);
}
</script>
</body>
</html>
